{% extends './Base.html'%}
  {% load static %}
  
    {% block css %}

    <style>
      .my-custom-scrollbar {
      position: relative;
      height: 400px;
      overflow: auto;
      }
      .table-wrapper-scroll-y {
      display: block;
      }
          </style>


{% endblock %}
{% block content %}
   <!-- NAVBAR START -->

   <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarTogglerDemo01">
      <img src="{% static '/images/logo.png' %}" class="logo-img" />
      <a class="navbar-brand" href="#">Eagle Eye</a>
      <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
        <li class="nav-item active">
          <a class="nav-link" href="{% url 'Twitter_Crawler:tweets_targets' %}">Twitter Crawler <span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item active">
          <a class="nav-link" href="#">Rapid Search</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="#">Image Reverse</a>
        </li>
       
      </ul>
     
    </div>
  </nav>
   <!-- NAVBAR END  -->

  <!--DASHBOARD BODY START --->
<div class="container-fluid">
  <div class="row">
    <div class="col-md-6">
      <!-- TOP WORLD TRENDS -->
      <div class="card">
        <div class="card-header">
          <span class="font-weight-bold">World top Trends</span>

          <button type="button"  class=" btn btn-sm btn-success float-right font-weight-bold updateTrendsBtn" data-id="0" id="0">update  <i class="fas fa-spinner fa-pulse" id="worldTrendSpinner"></i></button>
        </div>
        <div class="card-body m-0 p-0 ">
          <div class="table-wrapper-scroll-y my-custom-scrollbar">
          <table class="table table-bordered table-striped mb-0" >
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Hashtag</th>
                <th scope="col">Count</th>
               
              </tr>
            </thead>
            <tbody id="wrapperWorldTrends">
              {% for Trends in Top_World_Trends %}
             
              <tr>
                <th scope="row">{{forloop.counter}}</th>
                <td> <a href="{{Trends.href}}">{{Trends.name}}</a></td>
                <td>{{Trends.count}}</td>
              
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
        <div class="card-footer">
          <div class="row">
            <div class="col-md-4">
            <span class="text-info font-weight-bold" >Last udpated</span>  <span class="text-muted" id="syncWorldTrends"></span>
            </div>
          </div>
        </div>
      </div>
       <!-- TOP WORLD TRENDS -->
    </div>

    <div class="col-md-6">
      <!-- TOP WORLD TRENDS -->
      <div class="card">
        <div class="card-header">
          <span class="font-weight-bold">Pakistan Top Trends</span>
          <button type="button"  class=" btn btn-sm btn-success float-right font-weight-bold updateTrendsBtn" data-id="1" id="">update</button>
        </div>
        <div class="card-body m-0 p-0 ">
          <div class="table-wrapper-scroll-y my-custom-scrollbar">
          <table class="table table-bordered table-striped mb-0">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Hashtag</th>
                <th scope="col">Count</th>
               
              </tr>
            </thead>
            <tbody  id="wrapperPakistanTrends">
              {% for Trends in Pakistan_Top_Trends %}
             
              <tr>
                <th scope="row">{{forloop.counter}}</th>
                <td> <a href="{{Trends.href}}">{{Trends.name}}</a></td>
                <td>{{Trends.count}}</td>
              
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
        <div class="card-footer"></div>
      </div>
       <!-- TOP WORLD TRENDS -->
    </div>
  </div>
</div>
<!-- DASHBOARD BODY END  -->
{% endblock %}
   {% block js %}
  <script>
    $(document).ready(function(){
      $('#worldTrendSpinner').hide();
      $('#syncWorldTrends').empty().append(getCurrentTime())
      console.log("%c Jquery ready ! ","color:green;font-size:16px;font-weight:bold");
      const chatSocket = new WebSocket('ws://'+ window.location.host+'/topTrends/')
      console.log(chatSocket)




      chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log("%c"+data["_request"],"color:green;font-size:16px;font-weight:bold");
            let topTrends=data["_data"];
            let opCode=data["_data"];
            let containerId=opCode==0 ? 'wrapperWorldTrends' : 'wrapperPakistanTrends';
            populateTrends(topTrends,containerId)
            $('#syncWorldTrends').empty().append(getCurrentTime())
            
         
      }


chatSocket.onclose=function(e){
 console.log("%c"+"closing websocket ")
//  location.reload(true);
}
      // let updateTrendsBtn=
      $('.updateTrendsBtn').on('click',function(){
        $('#worldTrendSpinner').show();
        let btnId=$(this).attr('id');
        console.log(`Update trends button Id  == ${btnId}`);
        if(btnId==0){
          chatSocket.send(JSON.stringify({
            'opCode': btnId
            }));
        }
      })
    })



  function populateTrends(trends,containerId){
    let html='';
    $(`#${containerId}`).empty()
    trends.forEach(function(val,key){
      html+=`<tr><th scope="row">${key}</th><td> <a href="${val["href"]}">${val["name"]}</a></td><td>${val["count"]}</td></tr>`;
    })
    $(`#${containerId}`).append(html)
    let message ="Top World Hashtags updated";
    publishToastMessage(message,"success");
    $('#worldTrendSpinner').hide();
  }


 
    // var now = moment().startOf('seconds').fromNow();
   
 



 

 
  </script>
  {% endblock%}
 